{% extends 'base.html' %} {% load static %} {% block content %}
<section class="section-content padding-y bg">
  <div class="container">
    <h4 class="text-center mb-20">Review Your Order and Make Payment</h4>
    <div class="row">
      <aside class="col-lg-8">
        <div class="card">
          <h5 class="card-header">Billing Address</h5>
          <div class="card-body">
            <p class="card-text mb-0">{{order.full_name}}</p>
            <p class="card-text mb-0">{{order.full_address}}</p>
            <p class="card-text mb-0">{{order.city}}, {{order.state}}, {{order.country}}</p>
            <p class="card-text mb-0">{{order.email}}</p>
            <p class="card-text mb-0">{{order.phone}}</p>
            {% if order.order_note %}
            <b>Order Note: </b> {{order.order_note}} {% endif %}
          </div>
        </div>
        <div class="card">
          <h5 class="card-header">Payment Method</h5>
          <div class="card-body">
            <div class="form-check">
              <input class="form-check-input" type="radio" name="payment_method" id="khalti" value="Khalti" checked />
              <label class="form-check-label" for="khalti"> Khalti </label>
            </div>

            <div class="form-check mt-2">
              <input class="form-check-input" type="radio" name="payment_method" id="cod" value="Cash on Delivery" />
              <label class="form-check-label" for="cod"> Cash on Delivery </label>
            </div>
          </div>
        </div>

        <div class="card">
          <h5 class="card-header">Review Products</h5>
          <div class="card-body">
            <table class="table table-borderless table-shopping-cart">
              <thead class="text-muted">
                <tr class="small text-uppercase">
                  <th scope="col">Product</th>
                  <th scope="col" width="120">Quantity</th>
                  <th scope="col" width="120">Price</th>
                </tr>
              </thead>
              <tbody>
                {% for cart_item in cart_items %}
                <tr>
                  <td>
                    <figure class="itemside align-items-center">
                      <div class="aside"><img src="{{ cart_item.product.images.url }}" class="img-sm" /></div>
                      <figcaption class="info">
                        <a href="{{ cart_item.product.get_url }}" class="title text-dark">{{ cart_item.product.product_name }}</a>
                        <p class="text-muted small">
                          {% if cart_item.variations.all %} {% for item in cart_item.variations.all %} {{ item.variation_category | capfirst }} : {{ item.variation_value | capfirst }} <br />
                          {% endfor %} {% endif %}
                        </p>
                      </figcaption>
                    </figure>
                  </td>
                  <td>{{cart_item.quantity}}</td>
                  <td>
                    <div class="price-wrap">
                      <var class="price">Rs. {{ cart_item.sub_total }}</var>
                      <small class="text-muted"> Rs. {{ cart_item.product.price }} each </small>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </aside>

      <aside class="col-lg-4">
        <div class="card">
          <div class="card-body">
            <dl class="dlist-align">
              <dt>Total price:</dt>
              <dd class="text-right">Rs. {{total}}</dd>
            </dl>
            <dl class="dlist-align">
              <dt>Tax:</dt>
              <dd class="text-right">Rs. {{tax}}</dd>
            </dl>
            <dl class="dlist-align">
              <dt>Grand Total:</dt>
              <dd class="text-right text-dark b"><strong>Rs. {{grand_total}}</strong></dd>
            </dl>
            <hr />
            <p class="text-center mb-3">
              <img src="{% static './images/misc/payments.png' %}" height="26" />
            </p>

            <!-- Pay Now Button -->
            <button id="pay-btn" class="btn btn-primary btn-block">Pay Now</button>
          </div>
        </div>
        <div class="alert alert-danger" role="alert"><b>Please Note: </b>This is a demo website. Do not try to make real payments.</div>
      </aside>
    </div>
  </div>
</section>

<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      document.cookie.split(';').forEach(cookie => {
        cookie = cookie.trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        }
      });
    }
    return cookieValue;
  }

  const csrftoken = getCookie('csrftoken');
  const orderID = "{{ order.order_number }}";
  const amount = parseInt({{ grand_total }} * 100);

  document.getElementById("pay-btn").onclick = async function () {
    const paymentMethod = document.querySelector('input[name="payment_method"]:checked').value;

    // ðŸ”´ CASH ON DELIVERY
    if (paymentMethod === "Cash on Delivery") {
      window.location.href = "{% url 'order_complete' %}?purchase_order_id=" + orderID + "&status=Pending&payment_method=COD";
      return;
    }

    // ðŸŸ¢ KHALTI
    try {
      const res = await fetch("{% url 'payments' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrftoken
        },
        body: JSON.stringify({
          orderID: orderID,
          amount: amount
        })
      });

      const data = await res.json();
      if (data.payment_url) {
        window.location.href = data.payment_url;
      } else {
        alert("Khalti payment failed.");
        console.log(data);
      }
    } catch (err) {
      console.error(err);
      alert("Something went wrong.");
    }
  };
</script>

{% endblock %}
